# Understanding Kubernetes Provisioning Messages

## The "ExternalProvisioning" Message

You may see this message during volume provisioning:

```
Normal  ExternalProvisioning  Waiting for a volume to be created either by the 
        external provisioner 'csi.emma.ms' or manually by the system administrator. 
        If volume creation is delayed, please verify that the provisioner is running 
        and correctly registered.
```

## This is Normal Behavior ✅

This message is generated by **Kubernetes' persistentvolume-controller**, not by the CSI driver. It appears during the normal provisioning process.

## Why You See It

Kubernetes uses **exponential backoff** when waiting for external provisioners:

```
Time    Action
----    ------
0s      PVC created, provisioning starts
10s     First retry check
20s     Second retry check → "ExternalProvisioning" message appears
40s     Third retry check
80s     Fourth retry check
...
```

The message typically appears around **20 seconds** into provisioning, which is normal for cloud storage provisioning.

## What's Actually Happening

During those 20-30 seconds:

1. **CSI Controller** receives CreateVolume request
2. **Emma API** is called to create the volume
3. **Emma** provisions the volume in the cloud (AWS/GCP/Azure)
4. **Cloud Provider** creates the actual storage volume
5. **Emma API** waits for volume to be AVAILABLE
6. **CSI Controller** returns success to Kubernetes

This is the **normal cloud storage provisioning time**.

## Timeline Example

```
00:00 - PVC created
00:00 - Pod created (triggers provisioning)
00:01 - CSI Controller calls Emma API
00:02 - Emma API creates volume in AWS
00:15 - AWS volume is being created
00:20 - Kubernetes shows "ExternalProvisioning" message (normal!)
00:22 - AWS volume is ready
00:22 - Emma API returns success
00:22 - CSI Controller reports success
00:22 - PVC becomes Bound
```

## When to Worry

You should only be concerned if:

❌ **PVC stays Pending for > 2 minutes** - Check controller logs  
❌ **You see "ProvisioningFailed" events** - Check Emma API credentials  
❌ **Message appears for > 5 minutes** - Check Emma API status  
❌ **You see Warning or Error events** - Check logs for details  

## How to Check What's Really Happening

### 1. Check PVC Status
```bash
kubectl get pvc <pvc-name>
```

Expected: `Bound` within 30-60 seconds

### 2. Check Controller Logs
```bash
kubectl logs -n kube-system -l app=emma-csi-controller -c emma-csi-controller --tail=50
```

Look for:
```
Calling Emma API to create volume: name=..., size=...
Emma API returned volume ID 12345 (took 2s), waiting for AVAILABLE status
Volume 12345 is AVAILABLE (wait: 18s, total: 20s)
Volume created successfully
```

### 3. Check Events
```bash
kubectl describe pvc <pvc-name>
```

Look for the final event:
```
Normal  ProvisioningSucceeded  Successfully provisioned volume pvc-xxxxx
```

## Can We Change This?

**No**, we cannot change when Kubernetes shows this message. It's hardcoded in Kubernetes' persistentvolume-controller.

However, we can:

1. ✅ **Make provisioning faster** - Optimize Emma API calls
2. ✅ **Add better logging** - Show what's happening in controller logs
3. ✅ **Document the behavior** - This document!

## What We've Done

### Improved Logging

The controller now logs detailed timing information:

```
Calling Emma API to create volume: name=pvc-123, size=32GB, type=ssd, datacenter=aws-eu-central-1
Emma API returned volume ID 93801 (took 2.1s), waiting for AVAILABLE status
Volume 93801 is AVAILABLE (wait: 18.3s, total: 20.4s)
Volume created successfully
```

This helps you understand what's happening during the "ExternalProvisioning" phase.

### Typical Timings

Based on testing:

| Phase | Duration | What's Happening |
|-------|----------|------------------|
| Emma API call | 1-3s | Creating volume record |
| Cloud provisioning | 15-25s | AWS/GCP/Azure creating storage |
| Status check | 1-2s | Verifying volume is ready |
| **Total** | **20-30s** | **Normal provisioning time** |

## Comparison with Other CSI Drivers

For reference, other cloud CSI drivers have similar timings:

- **AWS EBS CSI**: 20-40 seconds
- **GCP PD CSI**: 15-30 seconds
- **Azure Disk CSI**: 25-45 seconds
- **Emma CSI**: 20-30 seconds ✅

Emma CSI is **competitive** with native cloud CSI drivers!

## Best Practices

### 1. Use WaitForFirstConsumer

This delays provisioning until a pod needs the volume:

```yaml
volumeBindingMode: WaitForFirstConsumer
```

Benefits:
- Volume created in same datacenter as pod
- No wasted volumes
- Faster overall pod startup

### 2. Pre-provision for Critical Workloads

For critical workloads, create PVCs ahead of time:

```bash
# Create PVC
kubectl apply -f pvc.yaml

# Wait for it to be bound
kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/my-pvc --timeout=60s

# Then create pod
kubectl apply -f pod.yaml
```

### 3. Monitor Provisioning Times

Set up alerts for slow provisioning:

```bash
# Check Prometheus metrics
curl http://controller:8080/metrics | grep emma_volume_create_duration
```

Alert if provisioning takes > 60 seconds.

## Troubleshooting

### Message Appears for > 2 Minutes

```bash
# Check controller is running
kubectl get pods -n kube-system -l app=emma-csi-controller

# Check controller logs
kubectl logs -n kube-system -l app=emma-csi-controller -c emma-csi-controller

# Check Emma API credentials
kubectl get secret emma-api-credentials -n kube-system
```

### ProvisioningFailed Event

```bash
# Get detailed error
kubectl describe pvc <pvc-name>

# Check controller logs for error
kubectl logs -n kube-system -l app=emma-csi-controller -c emma-csi-controller | grep -i error
```

Common causes:
- Invalid Emma API credentials
- Insufficient quota
- Invalid datacenter ID
- Network issues

## Summary

The "ExternalProvisioning" message is:

✅ **Normal behavior** - Appears during provisioning  
✅ **Informational** - Not an error  
✅ **Expected timing** - Appears around 20 seconds  
✅ **Cannot be changed** - Kubernetes built-in behavior  
✅ **Not a problem** - If provisioning completes in < 60 seconds  

**If you see "ProvisioningSucceeded" within 60 seconds, everything is working correctly!**

## Related Documentation

- [Kubernetes CSI Documentation](https://kubernetes-csi.github.io/docs/)
- [Emma API Documentation](https://docs.emma.ms)
- [CSI Driver Troubleshooting](TROUBLESHOOTING.md)
